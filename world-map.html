<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>World Whisky Map — Amber Palette</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --amber:#c7a97a;
  --amber-bright:#ffc66a;
  --ink:#f6f1e9;
  --bg1:#060606;
  --bg2:#14110f;
}

body{
  margin:0;
  background:radial-gradient(circle at top,var(--bg1),var(--bg2));
  font-family:'Noto Sans JP','Meiryo',sans-serif;
  color:var(--ink);
}

/* ヘッダー */
#headerBar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  padding:12px 12px;
  text-align:center;
  font-size:20px;
  background:rgba(0,0,0,0.82);
  border-bottom:1px solid #333;
  color:var(--amber);
  z-index:1000;
}

/* 地図 */
#map{
  width:100vw;
  height:100vh;
}

/* ----------------------------
   左側の旗ボタン
----------------------------- */
#areaButtons{
  position:fixed;
  bottom:80px;
  left:10px;
  z-index:9999;
  display:flex;
  flex-direction:column;
  gap:8px;
}

@media (max-width:600px){
  #areaButtons{
    bottom:100px;
    left:8px;
  }
}

.flag-btn{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 12px;
  min-width:140px;
  background:rgba(20,20,20,0.75);
  border:1px solid rgba(199,169,122,0.8);
  border-radius:999px;
  color:var(--ink);
  font-size:15px;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,0.45);
  backdrop-filter:blur(5px);
}

.flag-btn.active{
  background:linear-gradient(135deg,var(--amber-bright),#c07a2c);
  color:#1a1108;
  border-color:#f1d6a0;
}

.flag-icon{
  width:20px;
  height:14px;
  object-fit:cover;
  border-radius:2px;
}

/* Scotland のサブボタン（今は未使用） */
#scotlandSub{
  margin-left:6px;
  margin-top:4px;
  display:none;
  flex-direction:column;
  gap:4px;
}
.sub-btn{
  padding:4px 9px;
  border-radius:999px;
  border:1px solid rgba(199,169,122,0.7);
  background:rgba(15,15,15,0.85);
  color:var(--ink);
  font-size:12px;
  cursor:pointer;
}
.sub-btn.active{
  background:#c7a97a;
  color:#23160c;
}
.leaflet-marker-icon,
.leaflet-interactive {
  transition: all 0.25s ease;
}

</style>
</head>

<body>
<div id="headerBar">World Whisky Map — Amber Palette</div>
<div id="map"></div>

<!-- -------------------------
     国旗ボタン
-------------------------- -->
<div id="areaButtons">

  <!-- World（テキストのみ） -->
  <button class="flag-btn" onclick="showWorld()">World</button>

  <!-- Japan -->
  <button class="flag-btn" onclick="showJapan()">
    <img src="flags/japan.png" class="flag-icon"> Japan
  </button>

  <!-- USA -->
  <button class="flag-btn" onclick="showUSA()">
    <img src="flags/the_united_states.png" class="flag-icon"> USA
  </button>

  <!-- Canada -->
  <button class="flag-btn" onclick="showCanada()">
    <img src="flags/canada.gif" class="flag-icon"> Canada
  </button>

  <!-- Ireland -->
  <button class="flag-btn" onclick="showIreland()">
    <img src="flags/ireland.png" class="flag-icon"> Ireland
  </button>

  <!-- Scotland（メイン） -->
  <button class="flag-btn" onclick="toggleScotlandSub()">
    <img src="flags/scotland.png" class="flag-icon"> Scotland
  </button>

  <!-- Scotland 6エリア -->
  <div id="scotlandSub">
    <button class="sub-btn" onclick="showSpeyside()">Speyside</button>
    <button class="sub-btn" onclick="showHighlands()">Highlands</button>
    <button class="sub-btn" onclick="showLowlands()">Lowlands</button>
    <button class="sub-btn" onclick="showIslay()">Islay</button>
    <button class="sub-btn" onclick="showIslands()">Islands</button>
    <button class="sub-btn" onclick="showCampbeltown()">Campbeltown</button>
  </div>

  <!-- Others（地球アイコン） -->
  <button class="flag-btn" onclick="showOthers()">
    <img src="flags/world.png" class="flag-icon"> Others
  </button>

</div>


<!-- distillery データ（別ファイル） -->
<script src="distillery-data.js"></script>

<script>
// =====================================================
// 1. マップの初期化
// =====================================================
// ズームコントロールの位置などを調整したい場合はオプションを追加
const map = L.map('map', {
  zoomControl: false // ズームボタンを一旦消す場合（お好みで）
}).setView([20, 10], 2);

L.control.zoom({ position: 'topright' }).addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  minZoom: 2,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// マーカー管理用配列
let markers = [];

// =====================================================
// 2. 共通関数: マーカー削除 & 追加
// =====================================================

// マーカー全削除
function clearMarkers(){
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

// エリアごとのマーカー配置
function addAreaMarkers(arr){
  clearMarkers(); // まず消す
  let bounds = [];

  arr.forEach(d => {
    const lat = d.lat, lng = d.lng;
    if(!lat || !lng) return;

    // ★ Bar SPEC ロゴアイコン（特別処理）
    if (d.name === "Bar SPEC") {
      const logoIcon = L.icon({
        iconUrl: "icons/barspec.png", // パスが正しいか確認してください
        iconSize: [28, 28], 
        iconAnchor: [14, 14],
        popupAnchor: [0, -20],
        className: "barspec-icon"
      });

      const logoMarker = L.marker([lat, lng], { icon: logoIcon }).addTo(map);

      if (d.url) {
        logoMarker.on("dblclick", () => window.open(d.url, "_blank"));
      }
      
      // ツールチップ
      logoMarker.bindTooltip(`
        <div style="text-align:center;">
          <div style="font-size:15px; font-weight:bold;">Bar SPEC</div>
          <div style="font-size:12px; color:#d0c7b7;">Tokyo</div>
        </div>
      `, { direction: "top" });

      markers.push(logoMarker);
      bounds.push([lat, lng]);
      return; // Bar SPEC処理終了
    }

    // --- 通常の蒸留所マーカー ---
    const hasURL = d.url && d.url.trim() !== '';
    const radius = hasURL ? 8 : 5;
    const color  = hasURL ? "#d8a24a" : "#8c6b3b";

    // 円マーカーを作成
    const marker = L.circleMarker([lat, lng], {
      radius: radius,
      color: color,
      fillColor: color,
      fillOpacity: 0.85,
      weight: 1
    }).addTo(map);

    if (hasURL){
      marker.on('dblclick', () => window.open(d.url, "_blank"));
    }

    // ツールチップのラベル生成
    const name_jp = d.name_jp ?? d.name ?? "";
    const name_en = d.name_en ?? d.name ?? "";
    // 日本語があれば日本語をメインに、なければ英語
    const name_main = name_jp.trim() !== "" ? name_jp : name_en;
    
    // サブ名（地域名など）
    let name_sub = d.state_en ?? d.area ?? "";
    if(d.area && d.area.trim() !== "" && name_main === name_en){
      name_sub = d.area;
    } else if (name_main === name_jp && (!name_sub || name_sub.trim() === "")) {
      name_sub = name_en.trim() !== "" ? name_en : (d.state_en ?? "");
    }

    const label = `
      <div style="text-align:center;">
        <div style="font-size:15px; font-weight:bold;">${name_main}</div>
        <div style="font-size:12px; color:#d0c7b7;">${name_sub}</div>
      </div>
    `;
    marker.bindTooltip(label, { direction: 'top' });

    markers.push(marker);
    bounds.push([lat, lng]);
  });
  
  // マーカーがある範囲にズーム（World以外の場合に有効）
  // ※ World表示の時は別途 setView しているのでここは動作してもOK
  if(bounds.length > 0){
    // パディングをつけて範囲に収める
    map.fitBounds(bounds, {padding: [50, 50], maxZoom: 10});
  }
  
  // マーカー配置後にスタイル更新（サイズ合わせ）
  updateMarkerStyle();
}

// =====================================================
// 3. 表示切り替え関数
// =====================================================

function showWorld(){
  // 全データを結合（worldData変数がなくても動くように修正）
  // ※ distillery-data.js 内の変数名に合わせてください
  const allData = [
    ...(typeof japanData !== 'undefined' ? japanData : []),
    ...(typeof usaData !== 'undefined' ? usaData : []),
    ...(typeof canadaData !== 'undefined' ? canadaData : []),
    ...(typeof ukData !== 'undefined' ? ukData : []), // イングランド等
    ...(typeof irelandData !== 'undefined' ? irelandData : []),
    ...(typeof scotlandData !== 'undefined' ? scotlandData : []),
    ...(typeof othersData !== 'undefined' ? othersData : []),
    // エリア別データが重複していないか注意（scotlandDataにIslayなどが含まれているなら不要）
  ];
  
  // マーカー配置
  addAreaMarkers(allData);
  
  // Worldだけは強制的に全世界が見えるズーム位置に固定
  map.setView([25, 0], 2);
}

function showJapan(){ if(typeof japanData !== 'undefined') addAreaMarkers(japanData); }
function showUSA(){ if(typeof usaData !== 'undefined') addAreaMarkers(usaData); }
function showCanada(){ if(typeof canadaData !== 'undefined') addAreaMarkers(canadaData); }
function showIreland(){ if(typeof irelandData !== 'undefined') addAreaMarkers(irelandData); }
function showOthers(){ if(typeof othersData !== 'undefined') addAreaMarkers(othersData); }

// Scotland のサブメニュー切り替え
function toggleScotlandSub(){
  const s = document.getElementById("scotlandSub");
  s.style.display = (s.style.display === "flex") ? "none" : "flex";
  // ボタンを押しただけでScotland全域を表示したい場合は以下を有効化
  // if(typeof scotlandData !== 'undefined') addAreaMarkers(scotlandData);
}

// Scotland 各エリア
function showSpeyside(){ if(typeof speysideData !== 'undefined') addAreaMarkers(speysideData); }
function showHighlands(){ if(typeof highlandsData !== 'undefined') addAreaMarkers(highlandsData); }
function showLowlands(){ if(typeof lowlandsData !== 'undefined') addAreaMarkers(lowlandsData); }
function showIslay(){ if(typeof islayData !== 'undefined') addAreaMarkers(islayData); }
function showIslands(){ if(typeof islandsData !== 'undefined') addAreaMarkers(islandsData); }

function showCampbeltown(){
  if(typeof campbeltownData !== 'undefined') {
    addAreaMarkers(campbeltownData);
    // Campbeltownは狭いので個別にズーム調整したい場合
    setTimeout(() => {
       map.setView([55.42, -5.60], 13); 
    }, 100);
  }
}


// =====================================================
// 4. ズーム連動スタイル変更
// =====================================================
function updateMarkerStyle() {
  const zoom = map.getZoom();
  let size; 
  let opacity;

  // ズームレベルごとのサイズ設定
  if (zoom <= 4) { 
    size = 6;      // 引きのときは小さく
    opacity = 0.6;
  } 
  else if (zoom <= 7) { 
    size = 12;
    opacity = 0.8;
  } 
  else { 
    size = 18;     // 寄りのときは大きく
    opacity = 1.0;
  }

  markers.forEach(m => {
    // CircleMarker (通常) の場合
    if (m.setStyle) { 
      // CircleMarkerのradiusは「半径」なので size/2
      m.setStyle({ radius: size / 2, fillOpacity: opacity, opacity: opacity });
    }
    // Icon Marker (Bar SPECなど画像) の場合
    if (m.options.icon && m.setIcon) {
      // アイコンサイズを再設定
      // ※元のアイコンURLを保持しつつサイズだけ変える
      const oldIcon = m.options.icon;
      const newIcon = L.icon({
        iconUrl: oldIcon.options.iconUrl,
        iconSize: [size * 1.5, size * 1.5], // 画像は少し大きめに
        iconAnchor: [(size * 1.5)/2, (size * 1.5)/2],
        className: oldIcon.options.className
      });
      m.setIcon(newIcon);
    }
  });
}

// ズーム終了時にスタイル更新を実行
map.on("zoomend", updateMarkerStyle);


// =====================================================
// 5. 初期実行
// =====================================================
// ページ読み込み時は World を表示
showWorld();

</script>

</body>
</html>
